#include "diag_al.h"
#include <pthread.h>
#include "linux_types.h"
#include <stdio.h>
#include <stdlib.h>
#include <netinet/in.h>
#include <sys/types.h>
#include <linux/netlink.h>
#include <fcntl.h>
#include <sys/ioctl.h>
#include <net/if.h>
#include "diag.h"
#include <sys/time.h>

#define LOG_THP_FILE "/data/diag_thp.log"

static int diag_count;
static int diag_loop = 1;

int handle_arg(int argc, char *argv[])
{
	int i, ret = 0;
	char * cp, opt;

	for (i = 1; i < argc; i++)
	{
		cp = argv[i];
		if (*cp == '-')
		{
			opt = *(++cp);

			switch (opt)
			{
			case 'L':
			case 'l':
			{
				if ( (i + 1)  < argc )
				{
					i++;
					diag_loop = atoi( argv[i]);
					ret++;
				}
				break;
			}
			case 'c':
			case 'C':
			{
				if ( (i + 1)  < argc )
				{
					i++;
					diag_count = atoi( argv[i]);
					ret++;
				}
				break;
			}
			default:
				printf("Not enough argument.\n");
				ret = -1;
				break;
			}
		}
	}

	if (ret < 1)
	{
		printf("Usage: %s -c <diag count> [-l <diag loop>]\n", argv[0]);
		ret = -1;
	}

	return ret;
}

int main(int argc, char *argv[])
{
	int testUSBHandle;
	int i, j;
	struct timeval starttime;
	struct timeval endtime;
	long delta;
	long countbytes;
	long cut_num;
	int ret;
	int drop_num;
	FILE *logfile = NULL;

	//PLP message  - 41 14 00 00
	/*unsigned char testbuf[] = {
		0x18, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x12, 0x0C, 0x00,
		0xAD, 0x0A, 0x60, 0xC6, 0x86,
		0x19, 0x8A, 0x02, 0x04, 0x00,
		0x41, 0x14, 0x00, 0x00};*/

	//length: 1320 --> rrcDebugMeasResultInd
	unsigned char testbuf1[] = {
0x28,0x05,0x00,0x00,0x05,0x00,0x00,0x02,0x1F,0x04,0x91,0x19,0x33,0x05,0x02,
0x02,0x00,0x02,0x00,0x00,0x6C,0x7C,0x30,0x0A,0x06,0x05,0x00,0x00,0x1D,0x07,
0x07,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x13,0x00,0x57,0x27,0x47,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x99,0xFF,0x60,0x27,0x4E,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x9B,0xFF,0x70,0x27,0x51,0x00,0x01,
0xFF,0xFF,0xFF,0x01,0x00,0x01,0x00,0x01,0x00,0x9B,0xFF,0x78,0x27,0x41,0x00,
0x01,0xFF,0xFF,0xFF,0x01,0x00,0x01,0x00,0x01,0x00,0xA0,0xFF,0x60,0x27,0x31,
0x00,0x01,0xFF,0xFF,0xFF,0x01,0x00,0x01,0x00,0x01,0x00,0x9B,0xFF,0x68,0x27,
0x25,0x00,0x01,0xFF,0xFF,0xFF,0x01,0x00,0x01,0x00,0x01,0x00,0xB1,0xFF,0x78,
0x27,0x73,0x00,0x01,0xFF,0xFF,0xFF,0x01,0x00,0x01,0x00,0x01,0x00,0xA2,0xFF,
0x70,0x27,0x23,0x00,0x01,0xFF,0xFF,0xFF,0x01,0x00,0x01,0x00,0x01,0x00,0x9A,
0xFF,0x80,0x27,0x2E,0x00,0x01,0xFF,0xFF,0xFF,0x01,0x00,0x01,0x00,0x01,0x00,
0xA8,0xFF,0x68,0x27,0x75,0x00,0x01,0xFF,0xFF,0xFF,0x01,0x00,0x01,0x00,0x01,
0x00,0xA5,0xFF,0x80,0x27,0x61,0x00,0x01,0xFF,0xFF,0xFF,0x01,0x00,0x01,0x00,
0x01,0x00,0xAF,0xFF,0x68,0x27,0x78,0x00,0x01,0xFF,0xFF,0xFF,0x01,0x00,0x01,
0x00,0x01,0x00,0x9F,0xFF,0x57,0x27,0x6B,0x00,0x01,0xFF,0xFF,0xFF,0x01,0x00,
0x01,0x00,0x01,0x00,0x99,0xFF,0x68,0x27,0x64,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x01,0x00,0x9B,0xFF,0x68,0x27,0x5F,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x01,0x00,0x9D,0xFF,0x78,0x27,0x5C,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x01,0x00,0xB2,0xFF,0x60,0x27,0x3E,0x00,0x01,0xFF,
0xFF,0xFF,0x01,0x00,0x01,0x00,0x01,0x00,0xA6,0xFF,0x78,0x27,0x7D,0x00,0x01,
0xFF,0xFF,0xFF,0x01,0x00,0x01,0x00,0x01,0x00,0x9E,0xFF,0x57,0x27,0x51,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x9A,0xFF,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};

	if (handle_arg(argc, argv) == -1)
	{
		return -1;
	}

	logfile = fopen(LOG_THP_FILE, "a+");
	if (logfile == NULL)
	{
		printf( "can't open logfile `%s'\n", LOG_THP_FILE);
		return (-1);
	}


	printf("\n*****************************************************\n");
	printf("********** Enter Diag over USB throughput test*******\n");
	printf("*****************************************************\n");

	fprintf(logfile, "\n*****************************************************\n");
	fprintf(logfile, "********** Enter Diag over USB throughput test*******\n");
	fprintf(logfile, "*****************************************************\n");

	testUSBHandle = open("/dev/ttydiag0", O_RDWR | O_NOCTTY | O_NDELAY);
	if (testUSBHandle == -1)
	{
		printf("failed to init USB connection\n");
		return -1;
	}

	ioctl(testUSBHandle, DIAGSTUB_USBREMOVE, 0);

	// Just for debug use
	//write(testUSBHandle, "Test test 1", strlen("Test test 1"));
	//write(testUSBHandle, testbuf, sizeof(testbuf));

	for (j = 0; j < diag_loop; ++j)
	{
		gettimeofday(&starttime, NULL);

		for (cut_num = 0, drop_num = 0, i = 0, countbytes = 0; i < diag_count; ++i)
		{
			ret = write(testUSBHandle, testbuf1, sizeof(testbuf1));

			if (ret ==  sizeof(testbuf1))
			{
				countbytes += ret;
			}
			else if (ret > 0)
			{
				cut_num++;
			}
			else if (ret <= 0)
			{
				drop_num++;
			}
		}

		gettimeofday(&endtime, NULL);

		//printf("endtime.tv_usec %ld - starttime.tv_usec %ld\n", endtime.tv_usec, starttime.tv_usec);
		//printf("endtime.tv_sec %ld - starttime.tv_sec %ld\n", endtime.tv_sec, starttime.tv_sec);

		delta = (endtime.tv_usec - starttime.tv_usec)/1000 + 
		(endtime.tv_sec - starttime.tv_sec)*1000; //ms

		printf("*****************************************************\n");
		printf("====>>>  %d of total %d:\n", j+1, diag_loop);
		printf("====>>>  Total bytes: %ld Bytes\n", (long int)diag_count*sizeof(testbuf1));
		printf("====>>>  Package size: %ldbytes\n", (long int)sizeof(testbuf1));
		printf("====>>>  Total package number: %ld\n", (long int)diag_count);
		printf("====>>>  Drop package number: %ld\n", (long int)drop_num);
		printf("====>>>  Cut package number: %ld\n", cut_num);
		printf("====>>>  Total sent bytes: %ld Bytes\n", countbytes);
		printf("====>>>  Total sent time:  %ld ms\n", delta);
		printf("====>>>  Total Throughput: %ld KB/s\n", countbytes / delta);
		printf("*****************************************************\n");

		fprintf(logfile, "\n*****************************************************\n");
		fprintf(logfile, "====>>>  %d of total %d:\n", j+1, diag_loop);
		fprintf(logfile, "====>>>  Total bytes: %ld Bytes\n", (long int)diag_count*sizeof(testbuf1));
		fprintf(logfile, "====>>>  Package size: %ldbytes\n", (long int)sizeof(testbuf1));
		fprintf(logfile, "====>>>  Total package number: %ld\n", (long int)diag_count);
		fprintf(logfile, "====>>>  Drop package number: %ld\n", (long int)drop_num);
		fprintf(logfile, "====>>>  Cut package number: %ld\n", cut_num);
		fprintf(logfile, "====>>>  Total sent bytes: %ld Bytes\n", countbytes);
		fprintf(logfile, "====>>>  Total sent time:  %ld ms\n",delta);
		fprintf(logfile, "====>>>  Total Throughput: %ld KB/s\n",countbytes / delta);
		fprintf(logfile, "*****************************************************\n");
	}
	{
		time_t timep;
		time(&timep);

		printf("Timestamp:%s\n\n", ctime(&timep));
		fprintf(logfile, "Timestamp:%s\n", ctime(&timep));
	}
	fprintf(logfile, "*****************************************************\n\n");

	close(testUSBHandle);
	fclose(logfile);

	return 0;
}
